<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <!-- Om n√•got blockeras lokalt, kommentera CSP-raden nedan -->
  <!-- <meta http-equiv="Content-Security-Policy" content="default-src 'self' https: data: blob:; style-src 'self' 'unsafe-inline' https:; script-src 'self' 'unsafe-inline' https:; img-src * data: blob:; connect-src *;"> -->
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Veckobrev ‚Äì Karta (permal√§nk + datum + fels√∂kning)</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous" />
  <!-- MarkerCluster CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" crossorigin="anonymous"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" crossorigin="anonymous"/>

  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100vh; width: 100vw; }

    .map-topbar {
      position: absolute; z-index: 1000; top: 10px; left: 10px;
      background: rgba(255,255,255,0.95); padding: 10px 12px; border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.15);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; font-size: 14px;
      display: flex; gap: 10px; align-items: center; flex-wrap: wrap;
      max-width: min(94vw, 1100px);
    }

    .legend {
      position: absolute; z-index: 1000; bottom: 16px; left: 10px;
      background: rgba(255,255,255,0.95); padding: 10px 12px; border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.15); max-width: 360px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; font-size: 13px;
    }
    .legend .legend-header { display:flex; align-items:center; gap:8px; cursor:pointer; user-select:none; }
    .legend .legend-header h4 { margin:0; font-size:14px; }
    .legend .toggle { width: 22px; height: 22px; display:inline-flex; align-items:center; justify-content:center;
      border-radius: 6px; border:1px solid #ccc; background:#f6f6f6; }
    .legend .hint { font-size:12px; color:#777; margin-left:auto; }
    .legend .content { margin-top:8px; }
    .legend.collapsed .content { display:none; }
    .legend .row { display:grid; grid-template-columns: 22px 1fr; gap:8px; align-items:center; margin-bottom:6px; }

    .marker-emoji {
      width: 26px; height: 26px; display: inline-flex; align-items: center; justify-content: center;
      border-radius: 50%; color: #000; font-size: 16px; line-height: 1; box-shadow: 0 1px 4px rgba(0,0,0,0.3);
      border: 1px solid rgba(0,0,0,0.15); padding: 4px; background: #fff;
    }
    .popup h3 { margin: 0 0 6px; font-size: 16px; }
    .popup p { margin: 6px 0; }
    .popup .meta { color: #444; font-size: 12px; }
    .popup .actions { display:flex; gap:8px; margin-top:8px; }
    .popup .actions button { padding:6px 10px; border-radius:8px; border:1px solid #ddd; background:#f6f6f6; cursor:pointer; }

    .leaflet-control-layers-expanded { max-height: 60vh; overflow: auto; }

    .search-results {
      position: absolute; z-index: 999; top: 64px; left: 10px;
      width: 420px; max-height: 52vh; overflow: auto;
      background: rgba(255,255,255,0.98); border: 1px solid rgba(0,0,0,0.1);
      border-radius: 12px; box-shadow: 0 6px 24px rgba(0,0,0,0.15);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      display: none;
    }
    .search-results header { display:flex; align-items:center; justify-content:space-between; gap:8px;
      padding:8px 10px; border-bottom:1px solid #eee; position: sticky; top: 0; background: #fff; }
    .search-results header .actions { display:flex; gap:8px; }
    .search-results header button { padding:6px 10px; border-radius:8px; border:1px solid #ddd; background:#f6f6f6; cursor:pointer; }
    .search-results .list { padding: 6px; }
    .search-results .res { display:grid; grid-template-columns: 28px 1fr 26px; gap:10px; padding:8px; border-radius:10px; cursor:pointer; }
    .search-results .res:hover { background:#f7f7f7; }
    .search-results .ico {
      width:28px; height:28px; display:flex; align-items:center; justify-content:center;
      border-radius:50%; border:1px solid rgba(0,0,0,0.12); background:#fff; box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    .search-results .t { font-weight:600; font-size:14px; line-height:1.25; }
    .search-results .m { color:#555; font-size:12px; margin-top:2px; }
    .search-results .s { color:#777; font-size:11px; margin-top:2px; }
    .search-results .share { display:flex; align-items:center; justify-content:center; opacity:0.75; }
    .search-results .share:hover { opacity:1; }
    .search-results .empty { padding:12px; color:#666; font-size:13px; }

    .map-topbar input[type="search"] { max-width: min(42vw, 420px); }

    .datebox { display:flex; gap:6px; align-items:center; }
    .datebox input[type="date"] { padding:6px 8px; border:1px solid #ddd; border-radius:8px; }

    #errbar {
      position: fixed; z-index: 2000; left: 10px; right: 10px; bottom: 10px;
      background: #ffefef; color: #b00020; border: 1px solid #f5b0b0; border-radius: 10px;
      padding: 8px 12px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px;
      display: none; white-space: pre-wrap;
    }

    @media (max-width: 768px) {
      .map-topbar { left: 8px; top: 6px; padding: 8px 10px; gap: 6px; font-size: 13px; max-width: min(94vw, 520px); }
      .legend { left: 8px; bottom: 8px; padding: 8px 10px; font-size: 12px; max-width: 80vw; }
      .search-results { left: 8px; top: 58px; width: min(92vw, 460px); max-height: 50vh; }
      .map-topbar input[type="search"] { max-width: 52vw; }
      .datebox { width:100%; }
    }
  </style>
</head>
<body>

<div class="map-topbar">
  <div>
    <label for="focus-select"><strong>Fokusera karta:</strong></label>
    <select id="focus-select">
      <option value="world">Europa + Nordamerika</option>
      <option value="se">Sverige</option><option value="no">Norge</option><option value="dk">Danmark</option>
      <option value="de">Tyskland</option><option value="fi">Finland</option><option value="nl">Nederl√§nderna</option>
      <option value="fr">Frankrike</option><option value="at">√ñsterrike</option><option value="uk">Storbritannien</option>
      <option value="pl">Polen/Litauen/Tyskland</option><option value="md">Moldavien</option><option value="rs">Serbien</option>
      <option value="ua">Ukraina</option><option value="ve">Venezuela</option><option value="us">USA</option>
      <option value="be">Belgien</option><option value="cz">Tjeckien</option><option value="es">Spanien</option>
      <option value="it">Italien</option><option value="tr">Turkiet</option><option value="ch">Schweiz</option>
      <option value="lt">Litauen</option><option value="gr">Grekland</option><option value="ie">Irland</option>
    </select>
  </div>

  <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
    <input id="search-input" type="search" placeholder="S√∂k: t.ex. dr√∂nare, Karlskrona, cat:DRONE, country:SE" style="min-width:260px; padding:6px 8px; border:1px solid #ddd; border-radius:8px;" />
    <div class="datebox">
      <label for="from">Fr√•n</label><input id="from" type="date" />
      <label for="to">Till</label><input id="to" type="date" />
    </div>
    <button id="search-btn" style="padding:6px 10px; border-radius:8px; border:1px solid #ddd; background:#f5f5f5; cursor:pointer;">Filtrera</button>
    <button id="clear-btn"  style="padding:6px 10px; border-radius:8px; border:1px solid #ddd; background:#fff; cursor:pointer;">Rensa</button>
    <span id="hits" style="color:#444; font-size:12px;"></span>
  </div>
</div>

<div class="search-results" id="search-results">
  <header>
    <div id="res-title">S√∂kresultat</div>
    <div class="actions">
      <button id="res-zoom-all" title="Zooma till alla tr√§ffar">Zooma</button>
      <button id="res-close" title="St√§ng">St√§ng</button>
    </div>
  </header>
  <div class="list" id="res-list"></div>
</div>

<div id="map"></div>
<div class="legend" id="legend"></div>
<div id="errbar"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>
<!-- MarkerCluster JS -->
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js" crossorigin="anonymous"></script>

<script>
/* ====== Felvisare s√• sidan inte bara blir vit ====== */
(function () {
  const errbar = document.getElementById('errbar');
  function showErr(msg) {
    errbar.style.display = 'block';
    errbar.textContent = 'Fel: ' + msg;
    console.error(msg);
  }
  window.addEventListener('error', (e) => showErr(e.message || String(e)));
  window.addEventListener('unhandledrejection', (e) => showErr(e.reason && e.reason.message ? e.reason.message : String(e.reason)));
})();

/* ====== Karta & tiles ====== */
const isMobile = window.matchMedia('(max-width: 768px)').matches;
const map = L.map('map', { worldCopyJump: true, zoomControl: !isMobile }).setView([54.5, 10], 5);
if (isMobile) { L.control.zoom({ position: 'bottomright' }).addTo(map); map.scrollWheelZoom.disable(); }
const tiles = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
  attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> bidragsgivare'
}).addTo(map);
tiles.on('tileerror', () => {
  const b = document.getElementById('errbar');
  b.style.display = 'block';
  b.textContent = 'Obs: kunde inte ladda bakgrundskartan. Kontrollera internet/CSP.';
});
window.addEventListener('load', () => setTimeout(() => map.invalidateSize(), 0));

/* ====== Kategorier ====== */
const CATS = {
  DRONE:{label:'Dr√∂nare / UAV',emoji:'üõ©Ô∏è',color:'#d0e6ff'},
  INFRA:{label:'Infrastruktur / sabotage',emoji:'‚ö°',color:'#fff1b3'},
  NUCLEAR:{label:'K√§rnenergi / farligt gods',emoji:'‚ò¢Ô∏è',color:'#ffe0e0'},
  TERROR:{label:'Terror / v√•ld',emoji:'üí£',color:'#ffd6cc'},
  INTEL:{label:'Spionage / underr√§ttelse',emoji:'üïµÔ∏è‚Äç‚ôÇÔ∏è',color:'#e6e6e6'},
  LEGAL:{label:'R√§ttsfall / domar',emoji:'‚öñÔ∏è',color:'#e3ffe3'},
  MIL:{label:'Milit√§r / f√∂rsvar',emoji:'ü™ñ',color:'#e0f7f1'},
  HYBRID:{label:'P√•verkan / hybrid',emoji:'üß†',color:'#f0e6ff'},
  MAR:{label:'Maritimt / skuggflotta',emoji:'‚öì',color:'#e0f0ff'},
  GPS:{label:'GPS-st√∂rning / signal',emoji:'üì°',color:'#f5e6ff'},
  POLICY:{label:'Politik / policy',emoji:'üèõÔ∏è',color:'#f2ffe6'}
};
function makeClusterGroup(){
  return L.markerClusterGroup({ showCoverageOnHover:false, spiderfyOnMaxZoom:true, spiderfyDistanceMultiplier:1.2,
    disableClusteringAtZoom:8, maxClusterRadius:60, chunkedLoading:true });
}
const clustersByCat = {};
Object.keys(CATS).forEach(k => clustersByCat[k] = makeClusterGroup());
function makeIcon(catKey){
  const {emoji, color} = CATS[catKey] || {emoji:'‚ùì', color:'#eee'};
  return L.divIcon({ className:'', html:`<span class="marker-emoji" style="background:${color}">${emoji}</span>`, iconSize:[26,26], iconAnchor:[13,13] });
}

/* ====== DATA: klistra in dina listor h√§r ====== */
const events = [
  // Testpost ‚Äì ta bort n√§r du klistrar in dina egna
  {country:'DE',cat:'INTEL',title:'Spioneriutredning (test)',place:'Berlin',date:'2025-10-01',lat:52.52,lng:13.405,summary:'Exempelpost.',url:'https://example.com',source:'Demo'}
];
const additionalEvents = []; // valfritt

/* ====== Hj√§lp ====== */
const ALL_ITEMS = []; // [{ e, marker, key }]
let overlaysControl = null;
let CURRENT_RESULTS = [];

const qInput    = document.getElementById('search-input');
const fromInput = document.getElementById('from');
const toInput   = document.getElementById('to');
const hitsEl    = document.getElementById('hits');
const resBox    = document.getElementById('search-results');
const resList   = document.getElementById('res-list');
const resTitle  = document.getElementById('res-title');
const btnZoomAll= document.getElementById('res-zoom-all');

function norm(v){ return (v || '').toString().toLowerCase(); }
function esc(s){ return (s||'').toString().replace(/[&<>"]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m])); }
function eventKey(e){
  if (e.id) return `ID::${e.id}`;
  if (e.url && e.url.trim()) return `URL::${e.url.trim()}`;
  return `TDP::${(e.title||'').trim()}|${(e.date||'').trim()}|${(e.place||'').trim()}`;
}
function inDateRange(d, after, before){
  if (!d) return true;
  const x = new Date(d);
  if (after  && x < new Date(after))  return false;
  if (before && x > new Date(before)) return false;
  return true;
}
function parseQuery(q){
  const parts = (q||'').trim().split(/\s+/);
  const f = { text:[], cat:null, country:null, after:null, before:null };
  for (const p of parts) {
    const [k, ...rest] = p.split(':');
    if (rest.length){
      const val = rest.join(':'); const key = k.toLowerCase();
      if (key === 'cat') f.cat = val.toUpperCase();
      else if (key === 'country') f.country = val.toUpperCase();
      else if (key === 'after') f.after = val;
      else if (key === 'before') f.before = val;
      else f.text.push(p);
    } else if (p) f.text.push(p);
  }
  return f;
}
function matches(e, query, fromDate, toDate){
  const f = parseQuery(query||'');
  const after = f.after || fromDate || '';
  const before = f.before || toDate || '';
  if (f.cat){
    const catKey = (e.cat||'').toUpperCase();
    const catLabel = norm(CATS[e.cat]?.label);
    if (catKey !== f.cat && !(catLabel||'').includes(norm(f.cat))) return false;
  }
  if (f.country && (e.country||'').toUpperCase() !== f.country) return false;
  if (!inDateRange(e.date, after, before)) return false;
  if (!f.text.length) return true;
  const hay = norm([e.title, e.place, e.summary, e.source, e.cat, e.country, e.date].join(' | '));
  return f.text.every(w => hay.includes(norm(w)));
}
function catEmoji(e){ const meta = CATS[e.cat]; return meta ? meta.emoji : '‚ùì'; }
function catLabel(e){ const meta = CATS[e.cat]; return meta ? meta.label : (e.cat || 'Ok√§nd kategori'); }

/* ====== Popup + delning ====== */
function popupHtml(e){
  const cat = CATS[e.cat] ? CATS[e.cat].label : e.cat;
  const link = e.url ? `<p><a href="${e.url}" target="_blank" rel="noopener">√ñppna k√§lla</a></p>` : '';
  const src = e.source ? `<p class="meta">K√§lla: <strong>${esc(e.source)}</strong></p>` : '';
  const shareBtn = `<div class="actions">
      <button data-share="${encodeURIComponent(eventKey(e))}" class="share-btn">Kopiera permal√§nk</button>
    </div>`;
  return `<div class="popup">
    <h3>${esc(e.title)}</h3>
    <div class="meta">${esc(e.place)} ‚Ä¢ ${esc(e.date)} ‚Ä¢ ${esc(cat)}</div>
    <p>${esc(e.summary || '')}</p>
    ${src}
    ${link}
    ${shareBtn}
  </div>`;
}

/* ====== Indexering ====== */
function mergeEvents(a, b){
  const m = new Map();
  [...(a||[]), ...(b||[])].forEach(ev => { const k = eventKey(ev); if (!m.has(k)) m.set(k, ev); });
  return Array.from(m.values());
}
function indexEvents(data){
  data.forEach(e => {
    if (typeof e.lat !== 'number' || typeof e.lng !== 'number') return;
    const marker = L.marker([e.lat, e.lng], { icon: makeIcon(e.cat) }).bindPopup(popupHtml(e));
    (clustersByCat[e.cat] || clustersByCat.HYBRID).addLayer(marker);
    ALL_ITEMS.push({ e, marker, key: eventKey(e) });
  });
}
Object.keys(CATS).forEach(k => clustersByCat[k].addTo(map));
L.control.layers(null, Object.fromEntries(Object.entries(CATS).map(([k,v])=>[[`${v.emoji} ${v.label}`],clustersByCat[k]])), { collapsed: isMobile }).addTo(map);

/* ====== S√∂k/filtrera + resultatlista ====== */
function renderResults(items, query){
  const resBox = document.getElementById('search-results');
  const resList= document.getElementById('res-list');
  const resTitle= document.getElementById('res-title');

  CURRENT_RESULTS = items || [];
  if (!query && !fromInput.value && !toInput.value){
    resBox.style.display = 'none'; resList.innerHTML = ''; return;
  }
  const MAX = 120;
  const shown = CURRENT_RESULTS.slice(0, MAX);
  resTitle.textContent = `S√∂kresultat (${CURRENT_RESULTS.length})`;
  if (!shown.length){
    resList.innerHTML = `<div class="empty">Inga tr√§ffar.</div>`;
  } else {
    resList.innerHTML = shown.map((it, idx) => {
      const e = it.e;
      const meta = `${esc(e.place)} ‚Ä¢ ${esc(e.date)} ‚Ä¢ ${esc(catLabel(e))}`;
      const src  = e.source ? `K√§lla: ${esc(e.source)}` : '';
      const keyEnc = encodeURIComponent(it.key);
      return `
        <div class="res" data-idx="${idx}" title="Flyg till h√§ndelse">
          <div class="ico">${esc(catEmoji(e))}</div>
          <div class="txt">
            <div class="t">${esc(e.title)}</div>
            <div class="m">${meta}</div>
            <div class="s">${src}</div>
          </div>
          <a class="share" href="${makePermalink({id:keyEnc, q:qInput.value, from:fromInput.value, to:toInput.value})}" title="Kopiera permal√§nk" data-key="${keyEnc}">üîó</a>
        </div>`;
    }).join('');
  }
  resBox.style.display = 'block';
}
function applyFilter(query){
  Object.values(clustersByCat).forEach(c => c.clearLayers());
  const items = ALL_ITEMS.filter(it => matches(it.e, query, fromInput.value, toInput.value));
  items.forEach(it => (clustersByCat[it.e.cat] || clustersByCat.HYBRID).addLayer(it.marker));
  hitsEl.textContent = (query || fromInput.value || toInput.value) ? `Tr√§ffar: ${items.length}` : '';
  if (items.length){
    const fg = L.featureGroup(items.map(it => it.marker));
    map.fitBounds(fg.getBounds().pad(0.2));
    if (items.length === 1) setTimeout(() => items[0].marker.openPopup(), 250);
  }
  renderResults(items, query);
  pushSearchState({ q: query, from: fromInput.value, to: toInput.value });
  return items;
}

/* UI */
document.getElementById('search-btn').addEventListener('click', ()=>applyFilter(qInput.value));
document.getElementById('clear-btn').addEventListener('click', ()=>{
  qInput.value=''; fromInput.value=''; toInput.value=''; applyFilter(''); document.getElementById('search-results').style.display='none'; hitsEl.textContent=''; pushSearchState({});
});
document.getElementById('res-zoom-all').addEventListener('click', ()=>{
  if (!CURRENT_RESULTS.length) return;
  const fg = L.featureGroup(CURRENT_RESULTS.map(it => it.marker));
  map.fitBounds(fg.getBounds().pad(0.2));
});
document.getElementById('res-close').addEventListener('click', ()=>{ document.getElementById('search-results').style.display='none'; });
let _t=null; qInput.addEventListener('input', ()=>{ clearTimeout(_t); _t=setTimeout(()=>applyFilter(qInput.value), 250); });
[fromInput, toInput].forEach(el => el.addEventListener('change', ()=>applyFilter(qInput.value)));
document.getElementById('res-list').addEventListener('click', (ev)=>{
  const shareA = ev.target.closest('a.share');
  if (shareA){ ev.preventDefault(); copyPermalink(shareA.getAttribute('href')); return; }
  const row = ev.target.closest('.res'); if (!row) return;
  const idx = Number(row.getAttribute('data-idx')); const it = CURRENT_RESULTS[idx]; if (!it) return;
  map.setView(it.marker.getLatLng(), Math.max(map.getZoom(), 8), {animate:true});
  setTimeout(()=>it.marker.openPopup(),250);
});

/* Legend */
const legendEl = document.getElementById('legend');
const LS_KEY='legendCollapsed';
const initialCollapsed=(localStorage.getItem(LS_KEY)==='1')||isMobile;
legendEl.classList.toggle('collapsed', initialCollapsed);
legendEl.innerHTML = `
  <div class="legend-header" id="legend-header" role="button" tabindex="0" aria-expanded="${!initialCollapsed}">
    <span class="toggle" id="legend-toggle">${initialCollapsed?'+':'‚Äì'}</span>
    <h4>Teckenf√∂rklaring</h4>
    <span class="hint" id="legend-hint">${initialCollapsed?'Visa':'D√∂lj'}</span>
  </div>
  <div class="content" id="legend-content">
    ${Object.entries(CATS).map(([k,v])=>`
      <div class="row">
        <span class="marker-emoji" style="background:${v.color}">${v.emoji}</span>
        <div>${v.label}</div>
      </div>
    `).join('')}
  </div>`;
function setCollapsed(c){ legendEl.classList.toggle('collapsed', c); document.getElementById('legend-toggle').textContent=c?'+':'‚Äì'; document.getElementById('legend-hint').textContent=c?'Visa':'D√∂lj'; document.getElementById('legend-header').setAttribute('aria-expanded', String(!c)); localStorage.setItem(LS_KEY, c?'1':'0'); }
document.getElementById('legend-header').addEventListener('click', ()=>setCollapsed(!legendEl.classList.contains('collapsed')));
document.getElementById('legend-header').addEventListener('keydown',(e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); setCollapsed(!legendEl.classList.contains('collapsed')); }});

/* Fokusv√§ljare */
const FOCUS = {
  world:{center:[54.5,10],zoom:5}, se:{center:[62.0,16.0],zoom:5}, no:{center:[64.5,11.0],zoom:4},
  dk:{center:[56.0,10.0],zoom:6}, de:{center:[51.2,10.45],zoom:5}, fi:{center:[64.5,26.0],zoom:4},
  nl:{center:[52.3,5.3],zoom:7}, fr:{center:[47.0,2.0],zoom:5}, at:{center:[47.6,14.1],zoom:6},
  uk:{center:[53.5,-1.8],zoom:5}, pl:{center:[54.5,18.0],zoom:5}, md:{center:[47.0,28.7],zoom:7},
  rs:{center:[44.0,20.9],zoom:7}, ua:{center:[49.0,31.0],zoom:5}, ve:{center:[9.5,-66.5],zoom:6},
  us:{center:[39.8,-98.6],zoom:4}, be:{center:[50.8,4.5],zoom:7}, cz:{center:[49.8,15.5],zoom:7},
  es:{center:[41.4,-1.2],zoom:6}, it:{center:[42.6,12.6],zoom:5}, tr:{center:[39.0,35.0],zoom:5},
  ch:{center:[46.8,8.2],zoom:7}, lt:{center:[55.2,24.2],zoom:6}, gr:{center:[39.1,22.9],zoom:6},
  ie:{center:[53.2,-8.2],zoom:6}
};
document.getElementById('focus-select').addEventListener('change', (e)=>{
  const v = e.target.value; const f = FOCUS[v] || FOCUS.world; map.setView(f.center, f.zoom);
});

/* Permal√§nkar */
function makePermalink({id, q, from, to} = {}){
  const url = new URL(window.location.href);
  const p = url.searchParams;
  ['id','q','from','to'].forEach(k => p.delete(k));
  if (id) p.set('id', id);
  if (q) p.set('q', q);
  if (from) p.set('from', from);
  if (to) p.set('to', to);
  url.search = p.toString(); url.hash = '';
  return url.toString();
}
function pushSearchState({q, from, to}){
  const url = makePermalink({ q: q || '', from: from || '', to: to || '' });
  window.history.replaceState({}, '', url);
}
async function copyPermalink(url){ try{ await navigator.clipboard.writeText(url); alert('Permal√§nk kopierad.'); } catch{ prompt('Kopiera permal√§nk:', url); } }
map.on('popupopen', (ev) => {
  const it = ALL_ITEMS.find(x => x.marker === ev.popup._source);
  if (it){
    const keyEnc = encodeURIComponent(it.key);
    const url = makePermalink({ id: keyEnc, q: qInput.value || '', from: fromInput.value || '', to: toInput.value || '' });
    window.history.replaceState({}, '', url);
  }
  const tmp = document.createElement('div'); tmp.innerHTML = ev.popup.getContent();
  const btn = tmp.querySelector('button.share-btn');
  if (btn){
    const key = btn.getAttribute('data-share');
    btn.addEventListener('click', () => copyPermalink(makePermalink({ id: key, q: qInput.value || '', from: fromInput.value || '', to: toInput.value || '' })));
  }
  ev.popup.setContent(tmp.innerHTML);
});

/* Ladda fr√•n URL */
function loadFromURL(){
  const p = new URLSearchParams(window.location.search);
  const q = p.get('q') || '';
  const from = p.get('from') || '';
  const to = p.get('to') || '';
  const id = p.get('id');

  if (q) qInput.value = q;
  if (from) fromInput.value = from;
  if (to) toInput.value = to;

  const items = applyFilter(q);
  if (id){
    const key = decodeURIComponent(id);
    const it = ALL_ITEMS.find(x => x.key === key);
    if (it){
      map.setView(it.marker.getLatLng(), Math.max(map.getZoom(), 8), { animate: false });
      setTimeout(() => it.marker.openPopup(), 200);
    }
  }
}

/* Init */
(function init(){
  const merged = mergeEvents(events, additionalEvents);
  indexEvents(merged);
  if (ALL_ITEMS.length){
    const fg = L.featureGroup(ALL_ITEMS.map(it => it.marker));
    map.fitBounds(fg.getBounds().pad(0.2));
  }
  loadFromURL();
})();
</script>
</body>
</html>
